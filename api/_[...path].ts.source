/**
 * Vercel Serverless Function - Catch-all Route Handler
 *
 * 这个文件处理所有 /api/* 请求
 * 直接在这里构建 Express 应用，避免依赖外部编译文件
 */

import type { VercelRequest, VercelResponse } from '@vercel/node';
import express, { type Request, Response, NextFunction } from "express";
import cors from "cors";
import helmet from "helmet";
import rateLimit from "express-rate-limit";

// 懒加载 Express 应用
let app: express.Express | null = null;

async function getApp() {
  if (app) {
    return app;
  }

  console.log('[Vercel] Initializing Express app...');

  // 动态导入所有依赖（避免 Vercel 打包时的路径问题）
  const { registerRoutes } = await import('../server/routes');
  const { ensureRequiredEnv } = await import('../server/config/env');

  // 验证环境变量
  ensureRequiredEnv();

  app = express();

  // Security
  const supabaseUrl = process.env.SUPABASE_URL || process.env.VITE_SUPABASE_URL || '';

  app.use(helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        scriptSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
        imgSrc: ["'self'", "data:", "https:", "blob:"],
        connectSrc: ["'self'", ...(supabaseUrl ? [supabaseUrl] : []), "https://openrouter.ai"],
        fontSrc: ["'self'", "data:", "https://fonts.gstatic.com"],
        objectSrc: ["'none'"],
        baseUri: ["'self'"],
        formAction: ["'self'"],
        frameAncestors: ["'none'"],
      },
    },
    crossOriginEmbedderPolicy: false,
  }));

  // Rate limiting
  const apiLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 500,
    message: 'Too many requests from this IP, please try again later.',
    standardHeaders: true,
    legacyHeaders: false,
  });

  const aiLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 30,
    message: 'Too many AI requests, please try again later.',
    standardHeaders: true,
    legacyHeaders: false,
  });

  app.use('/api', apiLimiter);
  app.use('/api/ai', aiLimiter);

  // CORS - 安全的域名验证配置
  const isProduction = process.env.NODE_ENV === 'production';

  // 验证和解析 CORS_ORIGIN 环境变量
  function parseAllowedOrigins(corsOriginEnv: string | undefined): string[] {
    if (!corsOriginEnv) return [];

    const origins = corsOriginEnv.split(',').map(o => o.trim()).filter(Boolean);

    // 验证每个配置的源
    for (const origin of origins) {
      // 拒绝通配符
      if (origin === '*') {
        console.error('[CORS] ❌ Wildcard origin not allowed in configuration');
        throw new Error('Wildcard CORS origin not permitted');
      }

      // 验证 URL 格式
      try {
        const url = new URL(origin);
        if (url.protocol !== 'http:' && url.protocol !== 'https:') {
          throw new Error(`Invalid protocol: ${url.protocol}`);
        }
      } catch (err) {
        console.error(`[CORS] ❌ Invalid origin URL: ${origin}`, err);
        throw new Error(`Invalid CORS origin configuration: ${origin}`);
      }
    }

    return origins;
  }

  // 解析和验证配置的源
  const configuredOrigins = parseAllowedOrigins(process.env.CORS_ORIGIN);

  // 生产环境域名正则（精确匹配，防止子串攻击）
  const VERCEL_DOMAIN_REGEX = /^https:\/\/[a-z0-9-]+\.vercel\.app$/;
  const APP_DOMAIN_REGEX = /^https:\/\/(www\.)?hr-ai-recruit\.com$/;

  app.use(cors({
    origin: (origin, callback) => {
      // 在 Vercel 上，同源请求 origin 为 undefined
      if (!origin) {
        return callback(null, true);
      }

      // 生产环境：严格的域名验证
      if (isProduction) {
        // 1. 优先使用环境变量配置的源
        if (configuredOrigins.length > 0 && configuredOrigins.includes(origin)) {
          return callback(null, true);
        }

        // 2. 使用正则表达式精确匹配 Vercel 部署域名
        if (VERCEL_DOMAIN_REGEX.test(origin) || APP_DOMAIN_REGEX.test(origin)) {
          return callback(null, true);
        }

        // 3. 记录被拒绝的请求（生产环境不暴露详细信息）
        console.warn('[CORS] ⚠️ Blocked unauthorized origin');
        return callback(new Error('Not allowed by CORS'));
      }

      // 开发环境：允许所有本地地址
      if (origin.startsWith('http://localhost') || origin.startsWith('http://127.0.0.1')) {
        return callback(null, true);
      }

      callback(new Error('Not allowed by CORS'));
    },
    credentials: true,
    optionsSuccessStatus: 200,
  }));

  app.use(express.json());
  app.use(express.urlencoded({ extended: false }));

  // Request logging
  app.use((req, res, next) => {
    const start = Date.now();
    res.on("finish", () => {
      const duration = Date.now() - start;
      if (req.path.startsWith("/api")) {
        console.log(`${req.method} ${req.path} ${res.statusCode} in ${duration}ms`);
      }
    });
    next();
  });

  // Register routes
  await registerRoutes(app);

  // Error handler
  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err?.status || err?.statusCode || 500;
    const message = err?.message || "Internal Server Error";

    if (!res.headersSent) {
      res.status(status).json({ message });
    }

    console.error('[Express] Error:', err);
  });

  console.log('[Vercel] Express app initialized');

  return app;
}

export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    const app = await getApp();
    return app(req, res);
  } catch (error: any) {
    console.error('[Vercel Handler] Fatal error:', error);
    return res.status(500).json({
      error: 'Internal Server Error',
      message: error.message,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    });
  }
}
