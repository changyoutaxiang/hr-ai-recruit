# å€™é€‰äººç”»åƒåŠŸèƒ½ - å®Œæ•´ä¿®å¤æŠ¥å‘Š

> **ç”Ÿæˆæ—¥æœŸ**: 2025-10-09
> **åŠŸèƒ½æ¨¡å—**: å¯æˆé•¿çš„å€™é€‰äººç”»åƒç³»ç»Ÿ
> **ä½“æ£€è¯„åˆ†**: 8.6/10 - ä¼˜ç§€æ°´å¹³
> **ç´§æ€¥ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆå­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ï¼‰

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç»è¿‡å…¨é¢ä½“æ£€ï¼Œ"å¯æˆé•¿çš„å€™é€‰äººç”»åƒ"åŠŸèƒ½æ•´ä½“è®¾è®¡ä¼˜ç§€ï¼Œæ¶æ„åˆç†ï¼Œä½†å‘ç° **1 ä¸ªä¸¥é‡é—®é¢˜**ã€**3 ä¸ªä¸­ç­‰é—®é¢˜** å’Œ **2 ä¸ªè½»å¾®é—®é¢˜** éœ€è¦ä¿®å¤ã€‚

**å…³é”®å‘ç°**:
- âœ… ç‰ˆæœ¬åŒ–è®¾è®¡ä¼˜ç§€ï¼Œæ”¯æŒå®Œæ•´çš„å†å²å›æº¯
- âœ… å¹¶å‘æ§åˆ¶æœºåˆ¶å®Œå–„ï¼ˆæœåŠ¡å±‚ï¼‰
- âš ï¸ **æ•°æ®åº“å±‚ç‰ˆæœ¬å·ç”Ÿæˆå­˜åœ¨ç«æ€æ¡ä»¶**ï¼ˆä¸¥é‡ï¼‰
- âš ï¸ è¯æ®æå–é€»è¾‘ä¸å®Œæ•´
- âš ï¸ AI æç¤ºè¯é•¿åº¦ç®¡ç†éœ€è¦ä¼˜åŒ–

**å»ºè®®ä¼˜å…ˆçº§**:
1. ğŸ”´ **ç«‹å³ä¿®å¤**: ç‰ˆæœ¬å·ç”Ÿæˆå¹¶å‘å®‰å…¨é—®é¢˜
2. ğŸŸ¡ **çŸ­æœŸæ”¹è¿›**: è¯æ®æå–å®Œæ•´æ€§ã€AI æç¤ºè¯ä¼˜åŒ–
3. ğŸŸ¢ **é•¿æœŸä¼˜åŒ–**: ç”»åƒè´¨é‡è¯„åˆ†ã€å‰ç«¯æ€§èƒ½ä¼˜åŒ–

---

## ğŸ” è¯¦ç»†é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜ 1: ç‰ˆæœ¬å·ç”Ÿæˆçš„å¹¶å‘ç«æ€æ¡ä»¶

#### é—®é¢˜æè¿°

**å½±å“èŒƒå›´**: `server/storage.ts:1074-1126`

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ **é«˜** - å¯èƒ½å¯¼è‡´ç”Ÿäº§ç¯å¢ƒæ•°æ®é”™è¯¯

**é—®é¢˜ä»£ç **:
```typescript
// server/storage.ts:1074-1126
async createCandidateProfile(profile: Omit<InsertCandidateProfile, 'version'>): Promise<CandidateProfile> {
  // æ­¥éª¤1: æŸ¥è¯¢å½“å‰æœ€å¤§ç‰ˆæœ¬å·
  const existingProfiles = await db
    .select()
    .from(candidateProfiles)
    .where(eq(candidateProfiles.candidateId, profile.candidateId))
    .orderBy(desc(candidateProfiles.version));

  // æ­¥éª¤2: è®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
  const nextVersion = existingProfiles.length > 0
    ? existingProfiles[0].version + 1
    : 1;

  // âŒ é—®é¢˜: æ­¥éª¤1å’Œæ­¥éª¤3ä¹‹é—´æ²¡æœ‰åŸå­æ€§ä¿è¯
  // ä¸¤ä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½è¯»å–åˆ°ç›¸åŒçš„ç‰ˆæœ¬å·

  // æ­¥éª¤3: æ’å…¥æ–°è®°å½•
  const [newProfile] = await db.insert(candidateProfiles).values({
    ...profile,
    version: nextVersion,  // ğŸ’¥ å¯èƒ½è¿åå”¯ä¸€æ€§çº¦æŸ
  }).returning();

  return newProfile;
}
```

#### å¹¶å‘åœºæ™¯æ¨¡æ‹Ÿ

```
æ—¶é—´çº¿ï¼šå¹¶å‘åœºæ™¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¯·æ±‚ A: é¢è¯•å®˜æäº¤ç¬¬1è½®é¢è¯•åé¦ˆ
è¯·æ±‚ B: é¢è¯•å®˜æäº¤ç¬¬2è½®é¢è¯•åé¦ˆï¼ˆå‡ ä¹åŒæ—¶ï¼‰

T0: å½“å‰æ•°æ®åº“çŠ¶æ€: candidateId="123", æœ€å¤§ç‰ˆæœ¬å· = 2

T1: è¯·æ±‚AæŸ¥è¯¢ â†’ è¯»å–æœ€å¤§ç‰ˆæœ¬ = 2 â†’ è®¡ç®— nextVersion = 3
T2: è¯·æ±‚BæŸ¥è¯¢ â†’ è¯»å–æœ€å¤§ç‰ˆæœ¬ = 2 â†’ è®¡ç®— nextVersion = 3 (âŒ é‡å¤)

T3: è¯·æ±‚Aæ’å…¥ (candidateId=123, version=3) â†’ âœ… æˆåŠŸ
T4: è¯·æ±‚Bæ’å…¥ (candidateId=123, version=3) â†’ âŒ è¿åå”¯ä¸€æ€§çº¦æŸ

ç»“æœ: è¯·æ±‚Bå¤±è´¥ï¼Œç¬¬2è½®é¢è¯•åé¦ˆä¸¢å¤±ï¼Œç”¨æˆ·ä½“éªŒå—æŸ
```

#### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **æ•°æ®å®Œæ•´æ€§** | ğŸ”´ é«˜ | é¢è¯•åé¦ˆå¯èƒ½ä¸¢å¤± |
| **ç”¨æˆ·ä½“éªŒ** | ğŸ”´ é«˜ | æäº¤å¤±è´¥ï¼Œéœ€è¦é‡è¯• |
| **å‘ç”Ÿæ¦‚ç‡** | ğŸŸ¡ ä¸­ | å¤šä¸ªé¢è¯•å®˜åŒæ—¶æäº¤åé¦ˆæ—¶è§¦å‘ |
| **ä¿®å¤éš¾åº¦** | ğŸŸ¢ ä½ | æ ‡å‡†çš„äº‹åŠ¡å¤„ç†æ¨¡å¼ |
| **å½±å“èŒƒå›´** | `createCandidateProfile()` æ–¹æ³• |

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: æ•°æ®åº“äº‹åŠ¡ + è¡Œé”ï¼ˆæ¨èï¼‰**

ä½¿ç”¨ PostgreSQL çš„ `SELECT FOR UPDATE` å®ç°è¡Œçº§é”ï¼Œç¡®ä¿ç‰ˆæœ¬å·ç”Ÿæˆçš„åŸå­æ€§ã€‚

```typescript
// server/storage.ts
async createCandidateProfile(profile: Omit<InsertCandidateProfile, 'version'>): Promise<CandidateProfile> {
  const MAX_RETRIES = 3;
  let lastError: Error | null = null;

  for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
    try {
      // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
      const result = await db.transaction(async (tx) => {
        // ğŸ”’ SELECT FOR UPDATE é”å®šè¯¥å€™é€‰äººçš„æ‰€æœ‰ç”»åƒè®°å½•
        // å…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…æ­¤äº‹åŠ¡å®Œæˆ
        const existingProfiles = await tx
          .select()
          .from(candidateProfiles)
          .where(eq(candidateProfiles.candidateId, profile.candidateId))
          .orderBy(desc(candidateProfiles.version))
          .for('update');  // âœ¨ å…³é”®ï¼šè¡Œçº§é”

        // åœ¨äº‹åŠ¡å†…è®¡ç®—ç‰ˆæœ¬å·ï¼ˆæ­¤æ—¶å…¶ä»–äº‹åŠ¡è¢«é˜»å¡ï¼‰
        const nextVersion = existingProfiles.length > 0
          ? existingProfiles[0].version + 1
          : 1;

        // åœ¨åŒä¸€äº‹åŠ¡å†…æ’å…¥æ–°è®°å½•
        const [newProfile] = await tx.insert(candidateProfiles).values({
          ...profile,
          version: nextVersion,
        }).returning();

        return newProfile;
      });

      // âœ… æˆåŠŸï¼Œè¿”å›ç»“æœ
      console.log(`[createCandidateProfile] æˆåŠŸåˆ›å»ºç”»åƒç‰ˆæœ¬ ${result.version}`);
      return result;

    } catch (error) {
      lastError = error as Error;

      // å¦‚æœæ˜¯æœ€åä¸€æ¬¡é‡è¯•ï¼ŒæŠ›å‡ºé”™è¯¯
      if (attempt === MAX_RETRIES - 1) {
        console.error('[createCandidateProfile] é‡è¯•å¤±è´¥', {
          candidateId: profile.candidateId,
          attempts: MAX_RETRIES,
          error: lastError.message
        });
        throw new Error(`åˆ›å»ºå€™é€‰äººç”»åƒå¤±è´¥ï¼ˆå·²é‡è¯• ${MAX_RETRIES} æ¬¡ï¼‰: ${lastError.message}`);
      }

      // æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ100ms, 200ms, 400msï¼‰
      const delayMs = 100 * Math.pow(2, attempt);
      console.warn(`[createCandidateProfile] é‡è¯• ${attempt + 1}/${MAX_RETRIES}`, {
        candidateId: profile.candidateId,
        delayMs,
        error: lastError.message
      });

      await new Promise(resolve => setTimeout(resolve, delayMs));
    }
  }

  // ç†è®ºä¸Šä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼ˆä¸Šé¢å·²ç»æŠ›å‡ºé”™è¯¯ï¼‰
  throw lastError!;
}
```

**æ–¹æ¡ˆ 2: æ•°æ®åº“åºåˆ—ï¼ˆå¤‡é€‰ï¼‰**

å¦‚æœ Drizzle ORM æ”¯æŒåºåˆ—ï¼Œå¯ä»¥ä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼ï¼š

```sql
-- è¿ç§»è„šæœ¬: ä¸ºæ¯ä¸ªå€™é€‰äººåˆ›å»ºåºåˆ—
CREATE OR REPLACE FUNCTION get_next_profile_version(candidate_id_param VARCHAR)
RETURNS INTEGER AS $$
DECLARE
  next_version INTEGER;
BEGIN
  -- åŸå­æ“ä½œï¼šè·å–å¹¶æ›´æ–°ç‰ˆæœ¬å·
  SELECT COALESCE(MAX(version), 0) + 1
  INTO next_version
  FROM candidate_profiles
  WHERE candidate_id = candidate_id_param
  FOR UPDATE;

  RETURN next_version;
END;
$$ LANGUAGE plpgsql;
```

```typescript
// server/storage.ts
async createCandidateProfile(profile: Omit<InsertCandidateProfile, 'version'>): Promise<CandidateProfile> {
  const nextVersion = await db.execute(
    sql`SELECT get_next_profile_version(${profile.candidateId})`
  );

  const [newProfile] = await db.insert(candidateProfiles).values({
    ...profile,
    version: nextVersion,
  }).returning();

  return newProfile;
}
```

#### éªŒè¯æµ‹è¯•

```typescript
// test/storage.test.ts
describe('createCandidateProfile å¹¶å‘å®‰å…¨æµ‹è¯•', () => {
  it('åº”è¯¥å¤„ç†å¹¶å‘åˆ›å»ºè¯·æ±‚è€Œä¸äº§ç”Ÿé‡å¤ç‰ˆæœ¬', async () => {
    const candidateId = 'test-candidate-123';

    // æ¨¡æ‹Ÿ10ä¸ªå¹¶å‘è¯·æ±‚
    const promises = Array.from({ length: 10 }, (_, i) =>
      storage.createCandidateProfile({
        candidateId,
        jobId: null,
        stage: `test_stage_${i}`,
        profileData: { test: true },
        overallScore: '75',
        dataSources: ['test'],
        gaps: [],
        strengths: [],
        concerns: [],
        aiSummary: 'Test summary'
      })
    );

    // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
    const results = await Promise.all(promises);

    // éªŒè¯ç‰ˆæœ¬å·å”¯ä¸€æ€§
    const versions = results.map(r => r.version);
    const uniqueVersions = new Set(versions);

    expect(uniqueVersions.size).toBe(10);  // âœ… æ‰€æœ‰ç‰ˆæœ¬å·éƒ½ä¸åŒ
    expect(Math.min(...versions)).toBe(1);
    expect(Math.max(...versions)).toBe(10);
  });
});
```

#### å®æ–½æ­¥éª¤

1. **å¤‡ä»½æ•°æ®åº“**ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…åšï¼‰
   ```bash
   pg_dump -h your-host -U postgres -d your-db > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **åœ¨å¼€å‘ç¯å¢ƒå®æ–½æ–¹æ¡ˆ1**
   - ä¿®æ”¹ `server/storage.ts:1074-1126`
   - æ·»åŠ äº‹åŠ¡å¤„ç†å’Œè¡Œé”

3. **ç¼–å†™å¹¶è¿è¡Œå•å…ƒæµ‹è¯•**
   - æµ‹è¯•æ­£å¸¸åœºæ™¯
   - æµ‹è¯•å¹¶å‘åœºæ™¯ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰
   - æµ‹è¯•å¤±è´¥é‡è¯•æœºåˆ¶

4. **åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯**
   - ä½¿ç”¨ Apache JMeter æˆ– k6 è¿›è¡Œå¹¶å‘å‹æµ‹
   - éªŒè¯æ— ç‰ˆæœ¬å·å†²çª

5. **éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**
   - é€‰æ‹©ä½å³°æ—¶æ®µ
   - ç›‘æ§é”™è¯¯æ—¥å¿—

#### é¢„æœŸæ”¶ç›Š

- âœ… æ¶ˆé™¤ç‰ˆæœ¬å·å†²çªé£é™©
- âœ… æé«˜ç³»ç»Ÿå¯é æ€§
- âœ… æ”¹å–„ç”¨æˆ·ä½“éªŒï¼ˆæ— éœ€æ‰‹åŠ¨é‡è¯•ï¼‰
- âœ… ç¬¦åˆç”Ÿäº§ç¯å¢ƒæ ‡å‡†

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ 2: è¯æ®æå–é€»è¾‘ä¸å®Œæ•´

#### é—®é¢˜æè¿°

**å½±å“èŒƒå›´**: `server/services/candidateProfileService.ts:1173-1215`

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ **ä¸­** - å½±å“ç”»åƒæ¼”è¿›çš„å‡†ç¡®æ€§

**é—®é¢˜ä»£ç **:
```typescript
// candidateProfileService.ts:1173-1215
private extractEvidenceFromProfile(profile: CandidateProfile): Evidence[] {
  const evidence: Evidence[] = [];
  const profileData = profile.profileData as any;

  // âœ… æå–æŠ€æœ¯æŠ€èƒ½è¯æ®
  if (profileData.technicalSkills) {
    for (const skill of profileData.technicalSkills) {
      if (skill.evidence && Array.isArray(skill.evidence)) {
        evidence.push(...skill.evidence);
      }
    }
  }

  // âœ… æå–è½¯æŠ€èƒ½è¯æ®
  if (profileData.softSkills) {
    for (const skill of profileData.softSkills) {
      if (skill.evidence && Array.isArray(skill.evidence)) {
        evidence.push(...skill.evidence);
      }
    }
  }

  // âŒ ç¼ºå¤±: å·¥ä½œç»éªŒè¯æ®
  // âŒ ç¼ºå¤±: æ•™è‚²èƒŒæ™¯è¯æ®
  // âŒ ç¼ºå¤±: æ–‡åŒ–å¥‘åˆåº¦è¯æ®
  // âŒ ç¼ºå¤±: é¢†å¯¼åŠ›è¯„ä¼°è¯æ®
  // âŒ ç¼ºå¤±: èŒä¸šå‘å±•è½¨è¿¹è¯æ®
  // âŒ ç¼ºå¤±: ç»„ç»‡å¥‘åˆåº¦è¯æ®

  // âŒ ç¼ºå¤±: evidenceSummary ä¸­çš„è¯æ®ï¼ˆå¯èƒ½å¯¼è‡´è¯æ®ä¸¢å¤±ï¼‰

  return evidence;
}
```

#### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **ç”»åƒå‡†ç¡®æ€§** | ğŸŸ¡ ä¸­ | å†å²è¯æ®ä¸å®Œæ•´ï¼Œå½±å“æ¼”è¿›åˆ†æ |
| **è¯æ®é“¾å®Œæ•´æ€§** | ğŸŸ¡ ä¸­ | è¯æ®é“¾æ–­è£‚ï¼ŒAI åˆ¤æ–­ä¾æ®ä¸è¶³ |
| **çŸ›ç›¾æ£€æµ‹** | ğŸŸ¡ ä¸­ | ç¼ºå°‘è¯æ®å¯¼è‡´çŸ›ç›¾æ£€æµ‹ä¸å‡†ç¡® |
| **å‘ç”Ÿæ¦‚ç‡** | ğŸ”´ é«˜ | æ¯æ¬¡ç”»åƒæ›´æ–°éƒ½ä¼šè§¦å‘ |
| **ä¿®å¤éš¾åº¦** | ğŸŸ¢ ä½ | è¡¥å……æå–é€»è¾‘å³å¯ |

#### ä¿®å¤æ–¹æ¡ˆ

**å®Œæ•´çš„è¯æ®æå–å®ç°**:

```typescript
// server/services/candidateProfileService.ts
/**
 * ä»å€™é€‰äººç”»åƒä¸­æå–æ‰€æœ‰å†å²è¯æ®
 * ç¡®ä¿è¯æ®é“¾çš„å®Œæ•´æ€§å’Œè¿ç»­æ€§
 */
private extractEvidenceFromProfile(profile: CandidateProfile): Evidence[] {
  const evidence: Evidence[] = [];
  const profileData = profile.profileData as any;

  try {
    // 1. æå–æŠ€èƒ½è¯æ®ï¼ˆæŠ€æœ¯æŠ€èƒ½ + è½¯æŠ€èƒ½ï¼‰
    this.extractSkillEvidence(profileData, evidence);

    // 2. æå–å·¥ä½œç»éªŒè¯æ®
    this.extractExperienceEvidence(profileData, evidence);

    // 3. æå–æ•™è‚²èƒŒæ™¯è¯æ®
    this.extractEducationEvidence(profileData, evidence);

    // 4. æå–æ–‡åŒ–å¥‘åˆåº¦è¯æ®
    this.extractCulturalFitEvidence(profileData, evidence);

    // 5. æå–èŒä¸šå‘å±•è¯æ®
    this.extractCareerTrajectoryEvidence(profileData, evidence);

    // 6. æå–ç»„ç»‡å¥‘åˆåº¦è¯æ®ï¼ˆæ–‡åŒ–è¯„ä¼° + é¢†å¯¼åŠ›è¯„ä¼°ï¼‰
    this.extractOrganizationalFitEvidence(profileData, evidence);

    // 7. æå– evidenceSummary ä¸­çš„è¯æ®ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰
    if (profileData.evidenceSummary?.evidence && Array.isArray(profileData.evidenceSummary.evidence)) {
      evidence.push(...profileData.evidenceSummary.evidence);
    }

    // 8. å»é‡ï¼ˆåŸºäºè¯æ®IDæˆ–å†…å®¹å“ˆå¸Œï¼‰
    const deduped = this.deduplicateEvidence(evidence);

    this.log('info', 'ä»ç”»åƒä¸­æå–å†å²è¯æ®', {
      profileId: profile.id,
      totalExtracted: evidence.length,
      afterDedup: deduped.length,
      breakdown: {
        skills: evidence.filter(e => e.claimType === 'TECHNICAL_SKILL' || e.claimType === 'SOFT_SKILL').length,
        experience: evidence.filter(e => e.claimType === 'WORK_EXPERIENCE').length,
        cultural: evidence.filter(e => e.claimType === 'CULTURAL_FIT').length,
        // ... å…¶ä»–ç±»å‹ç»Ÿè®¡
      }
    });

    return deduped;
  } catch (error) {
    this.log('error', 'æå–å†å²è¯æ®å¤±è´¥', {
      profileId: profile.id,
      error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    });
    return [];
  }
}

/**
 * æå–æŠ€èƒ½è¯æ®ï¼ˆæŠ€æœ¯æŠ€èƒ½ + è½¯æŠ€èƒ½ï¼‰
 */
private extractSkillEvidence(profileData: any, evidence: Evidence[]): void {
  const skillTypes = ['technicalSkills', 'softSkills'];

  for (const skillType of skillTypes) {
    if (profileData[skillType] && Array.isArray(profileData[skillType])) {
      for (const skill of profileData[skillType]) {
        // æå–ç›´æ¥è¯æ®
        if (skill.evidence && Array.isArray(skill.evidence)) {
          evidence.push(...skill.evidence);
        }

        // æå–è¯æ®é“¾
        if (skill.evidenceChain?.supportingEvidence) {
          evidence.push(...skill.evidenceChain.supportingEvidence);
        }
      }
    }
  }
}

/**
 * æå–å·¥ä½œç»éªŒè¯æ®
 */
private extractExperienceEvidence(profileData: any, evidence: Evidence[]): void {
  if (profileData.experience?.positions && Array.isArray(profileData.experience.positions)) {
    for (const position of profileData.experience.positions) {
      // èŒä½æˆå°±è¯æ®
      if (position.evidence && Array.isArray(position.evidence)) {
        evidence.push(...position.evidence);
      }

      // å…³é”®æˆå°±çš„è¯æ®
      if (position.keyAchievements && Array.isArray(position.keyAchievements)) {
        for (const achievement of position.keyAchievements) {
          if (typeof achievement === 'object' && achievement.evidence) {
            evidence.push(...achievement.evidence);
          }
        }
      }
    }
  }

  // å·¥ä½œå¹´é™è¯æ®
  if (profileData.experience?.evidence) {
    evidence.push(...profileData.experience.evidence);
  }
}

/**
 * æå–æ•™è‚²èƒŒæ™¯è¯æ®
 */
private extractEducationEvidence(profileData: any, evidence: Evidence[]): void {
  if (profileData.education?.evidence && Array.isArray(profileData.education.evidence)) {
    evidence.push(...profileData.education.evidence);
  }
}

/**
 * æå–æ–‡åŒ–å¥‘åˆåº¦è¯æ®
 */
private extractCulturalFitEvidence(profileData: any, evidence: Evidence[]): void {
  if (profileData.culturalFit?.evidence && Array.isArray(profileData.culturalFit.evidence)) {
    evidence.push(...profileData.culturalFit.evidence);
  }

  // å·¥ä½œé£æ ¼è¯æ®
  if (profileData.culturalFit?.workStyle?.evidence) {
    evidence.push(...profileData.culturalFit.workStyle.evidence);
  }
}

/**
 * æå–èŒä¸šå‘å±•è½¨è¿¹è¯æ®
 */
private extractCareerTrajectoryEvidence(profileData: any, evidence: Evidence[]): void {
  if (profileData.careerTrajectory?.evidence && Array.isArray(profileData.careerTrajectory.evidence)) {
    evidence.push(...profileData.careerTrajectory.evidence);
  }
}

/**
 * æå–ç»„ç»‡å¥‘åˆåº¦è¯æ®ï¼ˆæ–‡åŒ–è¯„ä¼° + é¢†å¯¼åŠ›è¯„ä¼°ï¼‰
 */
private extractOrganizationalFitEvidence(profileData: any, evidence: Evidence[]): void {
  if (!profileData.organizationalFit) return;

  // æ–‡åŒ–è¯„ä¼°è¯æ®
  if (profileData.organizationalFit.cultureAssessment?.valueAssessments) {
    for (const valueAssessment of profileData.organizationalFit.cultureAssessment.valueAssessments) {
      if (valueAssessment.evidence && Array.isArray(valueAssessment.evidence)) {
        // å°†å­—ç¬¦ä¸²è¯æ®è½¬æ¢ä¸º Evidence å¯¹è±¡
        const evidenceObjects = valueAssessment.evidence.map((e: any) => {
          if (typeof e === 'string') {
            return {
              id: `cultural-${Date.now()}-${Math.random()}`,
              source: 'ai_analysis' as EvidenceSource,
              originalText: e,
              strength: 'moderate' as EvidenceStrength,
              confidence: 70,
              timestamp: new Date().toISOString()
            };
          }
          return e;
        });
        evidence.push(...evidenceObjects);
      }
    }
  }

  // é¢†å¯¼åŠ›è¯„ä¼°è¯æ®
  if (profileData.organizationalFit.leadershipAssessment?.dimensionScores) {
    for (const dimension of profileData.organizationalFit.leadershipAssessment.dimensionScores) {
      if (dimension.evidence && Array.isArray(dimension.evidence)) {
        const evidenceObjects = dimension.evidence.map((e: any) => {
          if (typeof e === 'string') {
            return {
              id: `leadership-${Date.now()}-${Math.random()}`,
              source: 'ai_analysis' as EvidenceSource,
              originalText: e,
              strength: 'moderate' as EvidenceStrength,
              confidence: 70,
              timestamp: new Date().toISOString()
            };
          }
          return e;
        });
        evidence.push(...evidenceObjects);
      }
    }
  }
}

/**
 * è¯æ®å»é‡
 * åŸºäºè¯æ®IDæˆ–å†…å®¹å“ˆå¸Œè¿›è¡Œå»é‡
 */
private deduplicateEvidence(evidence: Evidence[]): Evidence[] {
  const seen = new Map<string, Evidence>();

  for (const e of evidence) {
    // ä¼˜å…ˆä½¿ç”¨ ID
    if (e.id) {
      if (!seen.has(e.id)) {
        seen.set(e.id, e);
      }
      continue;
    }

    // å¦‚æœæ²¡æœ‰ IDï¼Œä½¿ç”¨å†…å®¹å“ˆå¸Œ
    const hash = this.hashEvidence(e);
    if (!seen.has(hash)) {
      seen.set(hash, e);
    }
  }

  return Array.from(seen.values());
}

/**
 * ç”Ÿæˆè¯æ®å†…å®¹å“ˆå¸Œï¼ˆç”¨äºå»é‡ï¼‰
 */
private hashEvidence(evidence: Evidence): string {
  const key = `${evidence.source}|${evidence.originalText}|${evidence.strength}`;
  return Buffer.from(key).toString('base64');
}
```

#### éªŒè¯æµ‹è¯•

```typescript
// test/candidateProfileService.test.ts
describe('extractEvidenceFromProfile', () => {
  it('åº”è¯¥æå–æ‰€æœ‰ç±»å‹çš„è¯æ®', () => {
    const mockProfile: CandidateProfile = {
      id: 'test-profile-1',
      candidateId: 'test-candidate-1',
      version: 2,
      stage: 'after_interview_1',
      profileData: {
        technicalSkills: [
          { skill: 'React', proficiency: 'advanced', evidenceSource: 'resume', evidence: [mockEvidence1] }
        ],
        softSkills: [
          { skill: 'Leadership', examples: ['Led team'], evidence: [mockEvidence2] }
        ],
        experience: {
          totalYears: 5,
          relevantYears: 4,
          positions: [
            {
              title: 'Senior Engineer',
              duration: '2020-2025',
              keyAchievements: ['Achievement 1'],
              evidence: [mockEvidence3]
            }
          ],
          evidence: [mockEvidence4]
        },
        education: {
          level: 'Bachelor',
          field: 'CS',
          evidence: [mockEvidence5]
        },
        culturalFit: {
          workStyle: 'Collaborative',
          evidence: [mockEvidence6]
        },
        organizationalFit: {
          cultureAssessment: {
            valueAssessments: [
              { valueName: 'Innovation', score: 85, evidence: ['Evidence string 1'] }
            ]
          }
        },
        evidenceSummary: {
          evidence: [mockEvidence7]
        }
      },
      // ... å…¶ä»–å­—æ®µ
    };

    const service = new CandidateProfileService();
    const extracted = service['extractEvidenceFromProfile'](mockProfile);

    // éªŒè¯æå–äº†æ‰€æœ‰è¯æ®
    expect(extracted.length).toBeGreaterThanOrEqual(7);

    // éªŒè¯å»é‡
    const ids = extracted.map(e => e.id);
    expect(ids.length).toBe(new Set(ids).size);
  });
});
```

#### å®æ–½æ­¥éª¤

1. **åˆ›å»ºæ–°çš„è¯æ®æå–æ–¹æ³•**
   - åœ¨ `candidateProfileService.ts` ä¸­æ·»åŠ ä¸Šè¿°æ–¹æ³•
   - ä¿æŒç°æœ‰ `extractEvidenceFromProfile` çš„ç­¾åä¸å˜

2. **ç¼–å†™å•å…ƒæµ‹è¯•**
   - æµ‹è¯•å„ç§è¯æ®ç±»å‹çš„æå–
   - æµ‹è¯•å»é‡é€»è¾‘
   - æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆç©ºæ•°æ®ã€æ ¼å¼é”™è¯¯ç­‰ï¼‰

3. **é€æ­¥éƒ¨ç½²**
   - å…ˆåœ¨å¼€å‘ç¯å¢ƒéªŒè¯
   - å¯¹æ¯”æ–°æ—§å®ç°çš„è¯æ®æ•°é‡ï¼ˆåº”è¯¥æ›´å¤šï¼‰
   - éªŒè¯ç”»åƒæ›´æ–°è´¨é‡æ˜¯å¦æå‡

4. **ç›‘æ§å’Œä¼˜åŒ–**
   - ç›‘æ§è¯æ®æå–æ•°é‡çš„å˜åŒ–
   - ä¼˜åŒ–å»é‡æ€§èƒ½ï¼ˆå¦‚æœè¯æ®é‡å¾ˆå¤§ï¼‰

#### é¢„æœŸæ”¶ç›Š

- âœ… è¯æ®é“¾å®Œæ•´æ€§æå‡ **50%+**
- âœ… ç”»åƒæ¼”è¿›å‡†ç¡®æ€§æå‡
- âœ… AI çŸ›ç›¾æ£€æµ‹æ›´å‡†ç¡®
- âœ… æ”¯æŒæ›´ä¸°å¯Œçš„è¯æ®ç»´åº¦

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ 3: AI æç¤ºè¯é•¿åº¦ç®¡ç†ä¸è¶³

#### é—®é¢˜æè¿°

**å½±å“èŒƒå›´**: `server/services/candidateProfileService.ts:658-813`

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ **ä¸­** - å¯èƒ½å¯¼è‡´ AI è°ƒç”¨å¤±è´¥æˆ–æˆæœ¬è¿‡é«˜

**é—®é¢˜åœºæ™¯**:
```typescript
// candidateProfileService.ts:712-756
const userPrompt = `å€™é€‰äººï¼š${candidate.name}

**å½“å‰ç”»åƒï¼ˆç¬¬ ${currentProfile.version} ç‰ˆï¼‰ï¼š**
- é˜¶æ®µï¼š${currentProfile.stage}
- ç»¼åˆè¯„åˆ†ï¼š${currentProfile.overallScore}
- å·²çŸ¥ä¼˜åŠ¿ï¼š${previousStrengths.join(", ")}  // å¯èƒ½å¾ˆé•¿
- å·²çŸ¥é¡¾è™‘ï¼š${previousConcerns.join(", ")}   // å¯èƒ½å¾ˆé•¿
- AI æ€»ç»“ï¼š${currentProfile.aiSummary || ""}  // 200-300å­—

**è¯æ®é“¾åˆ†æï¼š**
${evidenceSummary}  // âŒ å¯èƒ½å¾ˆé•¿ï¼ˆæ¯æ¡è¯æ®1è¡Œï¼‰

${contradictions.length > 0 ? `
**æ£€æµ‹åˆ°çš„è¯æ®çŸ›ç›¾ï¼š**
${contradictions.map(c => `- ${c.claim}: ${c.description}`).join("\n")}  // âŒ å¯èƒ½å¾ˆå¤š
` : ""}

**æœ€æ–°é¢è¯•ä¿¡æ¯ï¼ˆç¬¬ ${latestInterview.round} è½®ï¼‰ï¼š**
- é¢è¯•è¯„åˆ†ï¼š${latestInterview.rating || "æœªè¯„åˆ†"}/5
- é¢è¯•å®˜åé¦ˆï¼š${latestInterview.feedback || "æ— "}  // âŒ å¯èƒ½å¾ˆé•¿
- é¢è¯•å®˜ç¬”è®°ï¼š${latestInterview.interviewerNotes || "æ— "}  // âŒ å¯èƒ½å¾ˆé•¿
${transcription ? `- é¢è¯•è½¬å½•ï¼š${transcription}` : ""}  // âŒ å·²æˆªæ–­åˆ°2000å­—ç¬¦ï¼Œä½†ä»å¾ˆé•¿

**å†å²é¢è¯•è®°å½•ï¼ˆå…± ${allInterviews.length} è½®ï¼‰ï¼š**
${allInterviews.map(iv => `- ç¬¬ ${iv.round} è½®ï¼š${iv.type}ï¼Œè¯„åˆ† ${iv.rating || "N/A"}/5ï¼Œ${iv.recommendation || "æ— æ¨è"}`).join("\n")}
// âŒ å¦‚æœæœ‰10è½®é¢è¯•ï¼Œè¿™é‡Œå°±æœ‰10è¡Œ

${job ? `\n**ç›®æ ‡èŒä½ï¼š**
- èŒä½ï¼š${job.title}
- è¦æ±‚ï¼š${job.requirements ? (job.requirements as string[]).join(", ") : ""}  // âŒ å¯èƒ½å¾ˆé•¿
- æè¿°ï¼š${job.description}` : ""}  // âŒ å¯èƒ½å¾ˆé•¿
`;
```

**é£é™©è¯„ä¼°**:

| åœºæ™¯ | Token ä¼°ç®— | é£é™©ç­‰çº§ |
|------|-----------|---------|
| åˆå§‹ç”»åƒï¼ˆç®€å†ï¼‰ | 2,000-4,000 | ğŸŸ¢ å®‰å…¨ |
| ç¬¬1è½®é¢è¯•åæ›´æ–° | 3,000-6,000 | ğŸŸ¢ å®‰å…¨ |
| ç¬¬3è½®é¢è¯•åæ›´æ–° | 6,000-10,000 | ğŸŸ¡ è­¦å‘Š |
| ç¬¬5è½®é¢è¯•åæ›´æ–° | 10,000-15,000 | ğŸ”´ å±é™© |
| åŒ…å«é•¿è½¬å½•æ–‡æœ¬ | 15,000+ | ğŸ”´ å¯èƒ½è¶…é™ |

**å®é™…æ¡ˆä¾‹**:
- GPT-4 ä¸Šä¸‹æ–‡é™åˆ¶: 128K tokensï¼ˆçº¦ 96,000 æ±‰å­—ï¼‰
- GPT-4o ä¸Šä¸‹æ–‡é™åˆ¶: 128K tokens
- å•æ¬¡è°ƒç”¨å»ºè®®: < 30K tokensï¼ˆæˆæœ¬å’Œé€Ÿåº¦è€ƒè™‘ï¼‰

#### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **AI è°ƒç”¨å¤±è´¥** | ğŸŸ¡ ä¸­ | è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶æ—¶å¤±è´¥ |
| **æˆæœ¬å¢åŠ ** | ğŸŸ¡ ä¸­ | Token æ•°é‡ Ã— å•ä»· |
| **å“åº”é€Ÿåº¦** | ğŸŸ¡ ä¸­ | Token è¶Šå¤šï¼Œå“åº”è¶Šæ…¢ |
| **å‘ç”Ÿæ¦‚ç‡** | ğŸŸ¡ ä¸­ | å¤šè½®é¢è¯•åè§¦å‘ |
| **ä¿®å¤éš¾åº¦** | ğŸŸ¡ ä¸­ | éœ€è¦æ™ºèƒ½æ‘˜è¦é€»è¾‘ |

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: æ™ºèƒ½å†…å®¹å‹ç¼© + Token ä¼°ç®—**

```typescript
// server/services/candidateProfileService.ts

/**
 * é…ç½®: Token é™åˆ¶
 */
const TOKEN_LIMITS = {
  MAX_TOTAL_TOKENS: 30000,        // å•æ¬¡è°ƒç”¨æœ€å¤§ token
  MAX_HISTORY_TOKENS: 5000,       // å†å²é¢è¯•è®°å½•æœ€å¤§ token
  MAX_EVIDENCE_TOKENS: 3000,      // è¯æ®æ‘˜è¦æœ€å¤§ token
  MAX_TRANSCRIPTION_TOKENS: 2000, // é¢è¯•è½¬å½•æœ€å¤§ token
  CHARS_PER_TOKEN: 2.5,           // ä¸­æ–‡çº¦2.5å­—ç¬¦ = 1 token
} as const;

/**
 * ä¼°ç®—æ–‡æœ¬çš„ token æ•°é‡ï¼ˆç²—ç•¥ä¼°ç®—ï¼‰
 */
private estimateTokens(text: string): number {
  return Math.ceil(text.length / TOKEN_LIMITS.CHARS_PER_TOKEN);
}

/**
 * æ™ºèƒ½æˆªæ–­æ–‡æœ¬åˆ°ç›®æ ‡ token æ•°é‡
 */
private truncateToTokenLimit(text: string, maxTokens: number): string {
  const maxChars = maxTokens * TOKEN_LIMITS.CHARS_PER_TOKEN;

  if (text.length <= maxChars) {
    return text;
  }

  // åœ¨å¥å­è¾¹ç•Œæˆªæ–­ï¼ˆå¯»æ‰¾æœ€åçš„å¥å·ã€é—®å·æˆ–æ„Ÿå¹å·ï¼‰
  const truncated = text.substring(0, maxChars);
  const lastSentenceEnd = Math.max(
    truncated.lastIndexOf('ã€‚'),
    truncated.lastIndexOf('ï¼'),
    truncated.lastIndexOf('ï¼Ÿ'),
    truncated.lastIndexOf('\n')
  );

  if (lastSentenceEnd > maxChars * 0.8) {
    return truncated.substring(0, lastSentenceEnd + 1) + '...\n[å†…å®¹å·²æˆªæ–­]';
  }

  return truncated + '...\n[å†…å®¹å·²æˆªæ–­]';
}

/**
 * å‹ç¼©å†å²é¢è¯•è®°å½•
 */
private summarizeInterviewHistory(
  allInterviews: Interview[],
  latestInterview: Interview,
  maxTokens: number = TOKEN_LIMITS.MAX_HISTORY_TOKENS
): string {
  // æ’é™¤æœ€æ–°é¢è¯•ï¼ˆä¼šå•ç‹¬è¯¦ç»†å±•ç¤ºï¼‰
  const previousInterviews = allInterviews.filter(iv => iv.id !== latestInterview.id);

  if (previousInterviews.length === 0) {
    return 'é¦–æ¬¡é¢è¯•';
  }

  // ç®€åŒ–æ ¼å¼ï¼šåªä¿ç•™å…³é”®ä¿¡æ¯
  const summaries = previousInterviews.map(iv =>
    `ç¬¬${iv.round}è½®${iv.type}ï¼š${iv.rating || 'N/A'}/5ï¼Œ${iv.recommendation || 'æ— '}`
  );

  let result = summaries.join('\n');

  // å¦‚æœè¶…è¿‡é™åˆ¶ï¼Œè¿›ä¸€æ­¥å‹ç¼©
  if (this.estimateTokens(result) > maxTokens) {
    // åªä¿ç•™æœ€è¿‘çš„5è½®
    const recentSummaries = summaries.slice(-5);
    const omittedCount = summaries.length - recentSummaries.length;

    result = [
      `[çœç•¥å‰ ${omittedCount} è½®é¢è¯•]`,
      ...recentSummaries
    ].join('\n');
  }

  return result;
}

/**
 * å‹ç¼©è¯æ®æ‘˜è¦
 */
private buildEvidenceSummaryCompact(
  allEvidence: Evidence[],
  newEvidence: Evidence[],
  maxTokens: number = TOKEN_LIMITS.MAX_EVIDENCE_TOKENS
): string {
  const totalEvidence = allEvidence.length;
  const newEvidenceCount = newEvidence.length;

  const strongEvidence = allEvidence.filter(e =>
    e.strength === 'direct' || e.strength === 'strong'
  );

  const averageConfidence = totalEvidence > 0
    ? allEvidence.reduce((sum, e) => sum + (e.confidence || 50), 0) / totalEvidence
    : 0;

  const sources = Array.from(new Set(allEvidence.map(e => this.getEvidenceSourceLabel(e.source))));

  // åŸºç¡€æ‘˜è¦ï¼ˆæ€»æ˜¯åŒ…å«ï¼‰
  let summary = `
- æ€»è¯æ®æ•°ï¼š${totalEvidence} æ¡ï¼ˆæœ¬è½®æ–°å¢ ${newEvidenceCount} æ¡ï¼‰
- å¼ºåŠ›è¯æ®ï¼š${strongEvidence.length} æ¡ï¼ˆ${(strongEvidence.length / totalEvidence * 100).toFixed(0)}%ï¼‰
- å¹³å‡ç½®ä¿¡åº¦ï¼š${averageConfidence.toFixed(0)}%
- è¯æ®æ¥æºï¼š${sources.join('ã€')}
- è¯æ®å¯†åº¦ï¼š${totalEvidence > 10 ? 'å……åˆ†' : totalEvidence > 5 ? 'è‰¯å¥½' : 'ä¸€èˆ¬'}`;

  // å¦‚æœè¿˜æœ‰ token ä½™é‡ï¼Œæ·»åŠ å…³é”®è¯æ®ç¤ºä¾‹
  const currentTokens = this.estimateTokens(summary);
  const remainingTokens = maxTokens - currentTokens;

  if (remainingTokens > 500 && strongEvidence.length > 0) {
    const topEvidence = strongEvidence
      .sort((a, b) => (b.confidence || 0) - (a.confidence || 0))
      .slice(0, 3)  // åªå±•ç¤ºå‰3æ¡æœ€å¼ºè¯æ®
      .map(e => `  - ${e.originalText.substring(0, 100)}`)
      .join('\n');

    summary += `\n\nå…³é”®è¯æ®ç¤ºä¾‹ï¼š\n${topEvidence}`;
  }

  return summary;
}

/**
 * ç”Ÿæˆæ›´æ–°ç”»åƒï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 */
private async generateUpdatedProfileWithAI(
  candidate: Candidate,
  currentProfile: CandidateProfile,
  latestInterview: Interview,
  allInterviews: Interview[],
  job?: Job,
  newEvidence?: Evidence[]
): Promise<CandidateProfileData> {
  // 1. æå–å’Œåˆå¹¶è¯æ®
  const historicalEvidence = this.extractEvidenceFromProfile(currentProfile);
  const allEvidence = [...historicalEvidence, ...(newEvidence || [])];

  // 2. æ£€æµ‹è¯æ®çŸ›ç›¾
  const contradictions = await this.detectEvidenceContradictions(allEvidence);

  // 3. æ„å»ºå‹ç¼©åçš„è¯æ®æ‘˜è¦
  const evidenceSummary = this.buildEvidenceSummaryCompact(allEvidence, newEvidence || []);

  // 4. å‹ç¼©å†å²é¢è¯•è®°å½•
  const interviewHistory = this.summarizeInterviewHistory(allInterviews, latestInterview);

  // 5. å¤„ç†é¢è¯•è½¬å½•ï¼ˆå·²æœ‰ smartTruncateï¼Œç¡®ä¿ä¸è¶…è¿‡é™åˆ¶ï¼‰
  const transcription = latestInterview.transcription
    ? this.truncateToTokenLimit(
        this.sanitizeForPrompt(latestInterview.transcription),
        TOKEN_LIMITS.MAX_TRANSCRIPTION_TOKENS
      )
    : "";

  // 6. å‹ç¼©èŒä½ä¿¡æ¯
  let jobInfo = "";
  if (job) {
    const requirements = job.requirements
      ? (job.requirements as string[]).slice(0, 10).join(', ')  // æœ€å¤š10ä¸ªè¦æ±‚
      : '';
    const description = this.truncateToTokenLimit(job.description, 500);

    jobInfo = `\n**ç›®æ ‡èŒä½ï¼š**
- èŒä½ï¼š${job.title}
- è¦æ±‚ï¼š${requirements}
- æè¿°ï¼š${description}`;
  }

  // 7. æ„å»ºä¼˜åŒ–åçš„ prompt
  const systemPrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ HR ä¸“å®¶å’Œäººæ‰è¯„ä¼°ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºå€™é€‰äººçš„ç°æœ‰ç”»åƒå’Œæœ€æ–°çš„é¢è¯•åé¦ˆï¼Œæ›´æ–°å€™é€‰äººç”»åƒã€‚

**é‡è¦åŸåˆ™ï¼š**
1. **è¯æ®é©±åŠ¨**ï¼šæ‰€æœ‰è¯„ä¼°å¿…é¡»åŸºäºæ˜ç¡®çš„è¯æ®ï¼Œé¿å…ä¸»è§‚è‡†æ–­
2. **æ•´åˆæ–°ä¿¡æ¯**ï¼šå°†é¢è¯•ä¸­è·å¾—çš„æ–°ä¿¡æ¯ä¸ç°æœ‰ç”»åƒæ•´åˆ
3. **ä¿æŒä¸€è‡´æ€§**ï¼šç¡®ä¿æ›´æ–°åçš„ç”»åƒåœ¨é€»è¾‘ä¸Šä¸€è‡´
4. **çªå‡ºå˜åŒ–**ï¼šæ˜ç¡®æŒ‡å‡ºå“ªäº›ä¿¡æ¯æ˜¯æ–°å¢çš„ï¼Œå“ªäº›è¯„ä¼°æœ‰æ‰€è°ƒæ•´
5. **æ·±åŒ–ç†è§£**ï¼šåˆ©ç”¨é¢è¯•ä¿¡æ¯æ·±åŒ–å¯¹å€™é€‰äººçš„ç†è§£
6. **è¯†åˆ«çŸ›ç›¾**ï¼šå¦‚æœé¢è¯•åé¦ˆä¸ç®€å†ä¿¡æ¯æœ‰å‡ºå…¥ï¼Œéœ€è¦æ˜ç¡®æŒ‡å‡ºå¹¶åŸºäºè¯æ®å¼ºåº¦åˆ¤æ–­

**è¯æ®å¤„ç†è§„åˆ™**ï¼š
- ç›´æ¥è¯æ® (direct) > å¼ºè¯æ® (strong) > ä¸­ç­‰è¯æ® (moderate) > å¼±è¯æ® (weak) > æ¨æ–­è¯æ® (inferential)
- é¢è¯•éªŒè¯çš„è¯æ®ä¼˜å…ˆäºç®€å†å£°ç§°
- å½“è¯æ®çŸ›ç›¾æ—¶ï¼Œé€‰æ‹©è¯æ®å¼ºåº¦æ›´é«˜ã€æ¥æºæ›´å¯ä¿¡çš„ç»“è®º
- æ ‡æ³¨è¯æ®ä¸è¶³çš„è¯„ä¼°ä¸º"éœ€è¦è¿›ä¸€æ­¥éªŒè¯"

è¯·æ›´æ–°å€™é€‰äººç”»åƒï¼Œä½¿ç”¨ä¸åˆå§‹ç”»åƒç›¸åŒçš„ JSON ç»“æ„ï¼Œproficiency åªèƒ½æ˜¯: "beginner", "intermediate", "advanced", "expert" ä¹‹ä¸€ã€‚`;

  const previousStrengths = (currentProfile.strengths as string[]) || [];
  const previousConcerns = (currentProfile.concerns as string[]) || [];
  const previousGaps = (currentProfile.gaps as string[]) || [];

  const userPrompt = `å€™é€‰äººï¼š${this.sanitizeForPrompt(candidate.name)}

**å½“å‰ç”»åƒï¼ˆç¬¬ ${currentProfile.version} ç‰ˆï¼‰ï¼š**
- é˜¶æ®µï¼š${currentProfile.stage}
- ç»¼åˆè¯„åˆ†ï¼š${currentProfile.overallScore}
- å·²çŸ¥ä¼˜åŠ¿ï¼š${previousStrengths.slice(0, 5).join(", ")}${previousStrengths.length > 5 ? ` ç­‰${previousStrengths.length}é¡¹` : ''}
- å·²çŸ¥é¡¾è™‘ï¼š${previousConcerns.slice(0, 5).join(", ")}${previousConcerns.length > 5 ? ` ç­‰${previousConcerns.length}é¡¹` : ''}
- ä¿¡æ¯ç¼ºå£ï¼š${previousGaps.slice(0, 5).join(", ")}${previousGaps.length > 5 ? ` ç­‰${previousGaps.length}é¡¹` : ''}
- AI æ€»ç»“ï¼š${this.truncateToTokenLimit(currentProfile.aiSummary || "", 300)}

**è¯æ®é“¾åˆ†æï¼š**
${evidenceSummary}

${contradictions.length > 0 ? `
**æ£€æµ‹åˆ°çš„è¯æ®çŸ›ç›¾ï¼ˆå…± ${contradictions.length} ä¸ªï¼Œå±•ç¤ºå‰5ä¸ªï¼‰ï¼š**
${contradictions.slice(0, 5).map(c => `- ${c.claim}: ${c.description}`).join("\n")}
è¯·åœ¨æ›´æ–°ç”»åƒæ—¶æ˜ç¡®è§£å†³è¿™äº›çŸ›ç›¾ï¼ŒåŸºäºè¯æ®å¼ºåº¦å’Œæ¥æºå¯ä¿¡åº¦åšå‡ºåˆ¤æ–­ã€‚
` : ""}

**æœ€æ–°é¢è¯•ä¿¡æ¯ï¼ˆç¬¬ ${latestInterview.round} è½®ï¼‰ï¼š**
- é¢è¯•ç±»å‹ï¼š${latestInterview.type}
- é¢è¯•æ—¶é—´ï¼š${latestInterview.scheduledDate}
- é¢è¯•è¯„åˆ†ï¼š${latestInterview.rating || "æœªè¯„åˆ†"}/5
- é¢è¯•å®˜åé¦ˆï¼š${this.truncateToTokenLimit(this.sanitizeForPrompt(latestInterview.feedback || "æ— "), 800)}
- é¢è¯•å®˜ç¬”è®°ï¼š${this.truncateToTokenLimit(this.sanitizeForPrompt(latestInterview.interviewerNotes || "æ— "), 500)}
- æ¨èæ„è§ï¼š${latestInterview.recommendation || "æœªç»™å‡º"}
${transcription ? `- é¢è¯•è½¬å½•ï¼ˆæ‘˜è¦ï¼‰ï¼š${transcription}` : ""}
${latestInterview.aiKeyFindings ? `- AI å…³é”®å‘ç°ï¼š${JSON.stringify(latestInterview.aiKeyFindings).substring(0, 500)}` : ""}
${latestInterview.aiConcernAreas ? `- AI å…³æ³¨ç‚¹ï¼š${JSON.stringify(latestInterview.aiConcernAreas).substring(0, 500)}` : ""}

**å†å²é¢è¯•è®°å½•ï¼ˆå…± ${allInterviews.length} è½®ï¼‰ï¼š**
${interviewHistory}

${jobInfo}

**è¯·æ›´æ–°ç”»åƒï¼Œç¡®ä¿ï¼š**
1. åŸºäºè¯æ®æ•´åˆé¢è¯•ä¸­çš„æ–°ä¿¡æ¯
2. æ›´æ–°æŠ€èƒ½è¯„ä¼°ï¼ˆæ ‡æ˜è¯æ®æ¥æºå’Œå¼ºåº¦ï¼‰
3. è°ƒæ•´ç»¼åˆè¯„åˆ†ï¼ˆåŸºäºè¯æ®æ”¯æ’‘çš„é¢è¯•è¡¨ç°ï¼‰
4. æ›´æ–°ä¼˜åŠ¿ã€é¡¾è™‘å’Œä¿¡æ¯ç¼ºå£ï¼ˆåŒºåˆ†å·²éªŒè¯å’Œå¾…éªŒè¯ï¼‰
5. è§£å†³æ£€æµ‹åˆ°çš„è¯æ®çŸ›ç›¾
6. é‡æ–°ç”Ÿæˆ AI æ€»ç»“ï¼Œä½“ç°ç”»åƒæ¼”è¿›å’Œè¯æ®å¢å¼º`;

  // 8. Token ä¼°ç®—å’Œæ—¥å¿—
  const estimatedTokens = this.estimateTokens(systemPrompt + userPrompt);
  this.log('info', 'AI æç¤ºè¯ Token ä¼°ç®—', {
    candidateId: candidate.id,
    interviewId: latestInterview.id,
    estimatedTokens,
    breakdown: {
      systemPrompt: this.estimateTokens(systemPrompt),
      userPrompt: this.estimateTokens(userPrompt),
      evidenceSummary: this.estimateTokens(evidenceSummary),
      interviewHistory: this.estimateTokens(interviewHistory),
      transcription: this.estimateTokens(transcription),
    },
    withinLimit: estimatedTokens < TOKEN_LIMITS.MAX_TOTAL_TOKENS
  });

  // 9. å¦‚æœä»ç„¶è¶…é™ï¼Œé™çº§å¤„ç†
  if (estimatedTokens > TOKEN_LIMITS.MAX_TOTAL_TOKENS) {
    this.log('warn', 'Token æ•°é‡è¶…é™ï¼Œä½¿ç”¨é™çº§ç­–ç•¥', {
      candidateId: candidate.id,
      estimatedTokens,
      limit: TOKEN_LIMITS.MAX_TOTAL_TOKENS
    });

    // é™çº§ç­–ç•¥ï¼šç§»é™¤é¢è¯•è½¬å½•
    return await this.generateUpdatedProfileWithAI(
      candidate,
      currentProfile,
      { ...latestInterview, transcription: null },  // ç§»é™¤è½¬å½•
      allInterviews,
      job,
      newEvidence
    );
  }

  // 10. è°ƒç”¨ AI
  try {
    const result = await this.callAIWithRetry(
      {
        model: ADVANCED_MODEL,
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        response_format: { type: "json_object" },
        temperature: CONFIG.AI_TEMPERATURE,
      },
      CandidateProfileDataSchema,
      CONFIG.MAX_RETRIES,
      {
        operation: "profile_update_with_interview",
        entityType: "interview",
        entityId: latestInterview.id,
        metadata: {
          candidateId: candidate.id,
          interviewRound: latestInterview.round,
          interviewType: latestInterview.type,
          hasJob: !!job,
          evidenceCount: newEvidence?.length || 0,
          contradictionsDetected: contradictions.length,
          estimatedTokens,
        },
      }
    );

    // æ›´æ–°æ•°æ®æº
    const newDataSource = `ç¬¬${latestInterview.round}è½®é¢è¯•`;
    const previousDataSources = (currentProfile.dataSources as string[]) || [];
    result.dataSources = Array.from(new Set([
      ...previousDataSources,
      newDataSource
    ]));

    // æ›´æ–°è¯æ®æ‘˜è¦
    if (newEvidence) {
      const allEvidenceList = [...historicalEvidence, ...newEvidence];
      result.evidenceSummary = {
        totalEvidence: allEvidenceList.length,
        strongEvidence: allEvidenceList.filter(e =>
          e.strength === 'direct' || e.strength === 'strong'
        ).length,
        contradictions: contradictions.length,
        averageConfidence: allEvidenceList.reduce((sum, e) =>
          sum + (e.confidence || 50), 0
        ) / allEvidenceList.length,
        mainSources: Array.from(new Set(allEvidenceList.map(e => this.getEvidenceSourceLabel(e.source))))
      };
    }

    return result;
  } catch (error) {
    this.log('error', 'æ›´æ–°ç”»åƒæ—¶å‡ºé”™', {
      candidateId: candidate.id,
      interviewId: latestInterview.id,
      error,
      estimatedTokens
    });
    throw new Error("AI ç”»åƒæ›´æ–°å¤±è´¥: " + (error instanceof Error ? error.message : "æœªçŸ¥é”™è¯¯"));
  }
}
```

#### éªŒè¯æµ‹è¯•

```typescript
// test/candidateProfileService.test.ts
describe('Token ç®¡ç†æµ‹è¯•', () => {
  it('åº”è¯¥æ­£ç¡®ä¼°ç®— token æ•°é‡', () => {
    const service = new CandidateProfileService();
    const text = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ï¼Œå¤§çº¦æœ‰50ä¸ªæ±‰å­—ã€‚'.repeat(10);  // çº¦500å­—ç¬¦

    const tokens = service['estimateTokens'](text);

    expect(tokens).toBeGreaterThan(150);  // 500 / 2.5 = 200
    expect(tokens).toBeLessThan(250);
  });

  it('åº”è¯¥åœ¨å¥å­è¾¹ç•Œæˆªæ–­æ–‡æœ¬', () => {
    const service = new CandidateProfileService();
    const text = 'ç¬¬ä¸€å¥è¯ã€‚ç¬¬äºŒå¥è¯ã€‚ç¬¬ä¸‰å¥è¯ã€‚ç¬¬å››å¥è¯ã€‚';

    const truncated = service['truncateToTokenLimit'](text, 10);  // çº¦25å­—ç¬¦

    expect(truncated).toContain('ã€‚');
    expect(truncated).toContain('[å†…å®¹å·²æˆªæ–­]');
  });

  it('å¤šè½®é¢è¯•å token åº”åœ¨é™åˆ¶å†…', async () => {
    // æ¨¡æ‹Ÿ5è½®é¢è¯•çš„åœºæ™¯
    const mockData = createMockDataWith5Interviews();

    const service = new CandidateProfileService();

    // ç›‘è§† estimateTokens æ–¹æ³•
    const spy = jest.spyOn(service as any, 'estimateTokens');

    await service.generateUpdatedProfileWithAI(
      mockData.candidate,
      mockData.currentProfile,
      mockData.latestInterview,
      mockData.allInterviews,
      mockData.job
    );

    // éªŒè¯ token ä¼°ç®—è¢«è°ƒç”¨
    expect(spy).toHaveBeenCalled();

    // è·å–æœ€åä¸€æ¬¡è°ƒç”¨çš„ç»“æœ
    const lastCall = spy.mock.results[spy.mock.results.length - 1];
    const estimatedTokens = lastCall.value;

    expect(estimatedTokens).toBeLessThan(TOKEN_LIMITS.MAX_TOTAL_TOKENS);
  });
});
```

#### å®æ–½æ­¥éª¤

1. **æ·»åŠ  Token ç®¡ç†å·¥å…·æ–¹æ³•**
   - `estimateTokens()`
   - `truncateToTokenLimit()`
   - `summarizeInterviewHistory()`
   - `buildEvidenceSummaryCompact()`

2. **é‡æ„ `generateUpdatedProfileWithAI()`**
   - ä½¿ç”¨å‹ç¼©æ–¹æ³•
   - æ·»åŠ  Token ä¼°ç®—æ—¥å¿—
   - å®ç°é™çº§ç­–ç•¥

3. **ç¼–å†™æµ‹è¯•**
   - Token ä¼°ç®—å‡†ç¡®æ€§æµ‹è¯•
   - å‹ç¼©é€»è¾‘æµ‹è¯•
   - å¤šè½®é¢è¯•åœºæ™¯æµ‹è¯•

4. **ç›‘æ§å’Œè°ƒä¼˜**
   - æ”¶é›†å®é™… Token ä½¿ç”¨æ•°æ®
   - è°ƒæ•´å‹ç¼©å‚æ•°
   - ä¼˜åŒ–æ‘˜è¦ç®—æ³•

#### é¢„æœŸæ”¶ç›Š

- âœ… æ¶ˆé™¤ Token è¶…é™é£é™©
- âœ… é™ä½ AI è°ƒç”¨æˆæœ¬ï¼ˆå‡å°‘ä¸å¿…è¦çš„ Tokenï¼‰
- âœ… æå‡å“åº”é€Ÿåº¦ï¼ˆToken å°‘ = æ›´å¿«ï¼‰
- âœ… æ”¯æŒæ›´å¤šè½®æ¬¡çš„é¢è¯•

---

### ğŸŸ¢ è½»å¾®é—®é¢˜ 4: ç¼ºå°‘ç”»åƒè´¨é‡è¯„åˆ†æœºåˆ¶

#### é—®é¢˜æè¿°

**å½±å“èŒƒå›´**: æ•´ä¸ªç”»åƒç”Ÿæˆæµç¨‹

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ **ä½** - ä¸å½±å“åŠŸèƒ½ï¼Œä½†ç¼ºå°‘è´¨é‡åé¦ˆ

**å½“å‰çŠ¶æ€**:
- âœ… ç”Ÿæˆç”»åƒ
- âœ… æå–è¯æ®
- âœ… è®¡ç®—ç»¼åˆè¯„åˆ†
- âŒ **ç¼ºå¤±**ï¼šç”»åƒè´¨é‡è¯„ä¼°
- âŒ **ç¼ºå¤±**ï¼šä¿¡æ¯å®Œæ•´åº¦è¯„åˆ†
- âŒ **ç¼ºå¤±**ï¼šæ”¹è¿›å»ºè®®

#### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **ç”¨æˆ·ä½“éªŒ** | ğŸŸ¢ ä½ | ç”¨æˆ·ä¸çŸ¥é“ç”»åƒè´¨é‡å¦‚ä½• |
| **æ”¹è¿›æŒ‡å¯¼** | ğŸŸ¢ ä½ | ç¼ºå°‘ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®® |
| **è´¨é‡ç›‘æ§** | ğŸŸ¢ ä½ | æ— æ³•é‡åŒ–ç”»åƒè´¨é‡ |
| **å‘ç”Ÿæ¦‚ç‡** | ğŸ”´ é«˜ | æ¯æ¬¡ç”Ÿæˆç”»åƒéƒ½ç¼ºå¤± |
| **ä¿®å¤éš¾åº¦** | ğŸŸ¡ ä¸­ | éœ€è¦è®¾è®¡è¯„åˆ†ç®—æ³• |

#### ä¿®å¤æ–¹æ¡ˆ

**æ·»åŠ ç”»åƒè´¨é‡è¯„ä¼°ç³»ç»Ÿ**:

```typescript
// server/services/candidateProfileService.ts

/**
 * ç”»åƒè´¨é‡åº¦é‡
 */
interface ProfileQualityMetrics {
  /** ä¿¡æ¯å®Œæ•´åº¦è¯„åˆ† (0-100) */
  completeness: number;

  /** è¯æ®å¼ºåº¦è¯„åˆ† (0-100) */
  evidenceStrength: number;

  /** æ•´ä½“ç½®ä¿¡åº¦ (0-100) */
  confidence: number;

  /** ä¿¡æ¯ç¼ºå£åˆ—è¡¨ */
  gaps: string[];

  /** æ”¹è¿›å»ºè®® */
  recommendations: string[];

  /** è´¨é‡ç­‰çº§ */
  qualityLevel: 'excellent' | 'good' | 'fair' | 'poor';

  /** è¯¦ç»†è¯„åˆ† */
  breakdown: {
    technicalSkillsCoverage: number;
    softSkillsCoverage: number;
    experienceVerification: number;
    culturalFitAssessment: number;
    evidenceQuality: number;
  };
}

/**
 * è¯„ä¼°å€™é€‰äººç”»åƒçš„è´¨é‡
 */
async assessProfileQuality(profile: CandidateProfile): Promise<ProfileQualityMetrics> {
  const profileData = profile.profileData as ProfileData;

  // 1. è®¡ç®—å®Œæ•´åº¦è¯„åˆ†
  const completeness = this.calculateCompleteness(profileData);

  // 2. è®¡ç®—è¯æ®å¼ºåº¦è¯„åˆ†
  const evidenceStrength = this.calculateEvidenceStrength(profileData);

  // 3. è®¡ç®—æ•´ä½“ç½®ä¿¡åº¦
  const confidence = Math.round(completeness * 0.4 + evidenceStrength * 0.6);

  // 4. è¯†åˆ«ä¿¡æ¯ç¼ºå£
  const gaps = this.identifyGaps(profileData);

  // 5. ç”Ÿæˆæ”¹è¿›å»ºè®®
  const recommendations = this.generateRecommendations(profileData, gaps, confidence);

  // 6. ç¡®å®šè´¨é‡ç­‰çº§
  const qualityLevel = this.determineQualityLevel(confidence);

  // 7. è¯¦ç»†è¯„åˆ†åˆ†è§£
  const breakdown = this.calculateDetailedBreakdown(profileData);

  const metrics: ProfileQualityMetrics = {
    completeness,
    evidenceStrength,
    confidence,
    gaps,
    recommendations,
    qualityLevel,
    breakdown
  };

  this.log('info', 'ç”»åƒè´¨é‡è¯„ä¼°å®Œæˆ', {
    profileId: profile.id,
    qualityLevel,
    confidence,
    gapsCount: gaps.length,
    recommendationsCount: recommendations.length
  });

  return metrics;
}

/**
 * è®¡ç®—ä¿¡æ¯å®Œæ•´åº¦ (0-100)
 */
private calculateCompleteness(profileData: ProfileData): number {
  let score = 0;
  let maxScore = 0;

  // æŠ€æœ¯æŠ€èƒ½ (20åˆ†)
  maxScore += 20;
  if (profileData.technicalSkills && profileData.technicalSkills.length > 0) {
    score += 10;
    if (profileData.technicalSkills.length >= 5) score += 5;
    if (profileData.technicalSkills.some(s => s.proficiency === 'expert' || s.proficiency === 'advanced')) score += 5;
  }

  // è½¯æŠ€èƒ½ (15åˆ†)
  maxScore += 15;
  if (profileData.softSkills && profileData.softSkills.length > 0) {
    score += 8;
    if (profileData.softSkills.length >= 3) score += 4;
    if (profileData.softSkills.some(s => s.examples && s.examples.length > 0)) score += 3;
  }

  // å·¥ä½œç»éªŒ (25åˆ†)
  maxScore += 25;
  if (profileData.experience) {
    score += 10;
    if (profileData.experience.totalYears > 0) score += 5;
    if (profileData.experience.positions && profileData.experience.positions.length > 0) score += 5;
    if (profileData.experience.positions?.some(p => p.keyAchievements.length > 0)) score += 5;
  }

  // æ•™è‚²èƒŒæ™¯ (10åˆ†)
  maxScore += 10;
  if (profileData.education) {
    score += 5;
    if (profileData.education.level && profileData.education.field) score += 5;
  }

  // æ–‡åŒ–å¥‘åˆåº¦ (15åˆ†)
  maxScore += 15;
  if (profileData.culturalFit) {
    score += 8;
    if (profileData.culturalFit.workStyle) score += 3;
    if (profileData.culturalFit.motivations && profileData.culturalFit.motivations.length > 0) score += 4;
  }

  // èŒä¸šå‘å±• (15åˆ†)
  maxScore += 15;
  if (profileData.careerTrajectory) {
    score += 8;
    if (profileData.careerTrajectory.progression) score += 4;
    if (profileData.careerTrajectory.growthAreas && profileData.careerTrajectory.growthAreas.length > 0) score += 3;
  }

  return Math.round((score / maxScore) * 100);
}

/**
 * è®¡ç®—è¯æ®å¼ºåº¦ (0-100)
 */
private calculateEvidenceStrength(profileData: any): number {
  let totalEvidence = 0;
  let strongEvidenceCount = 0;
  let totalConfidence = 0;

  // ä»æ‰€æœ‰å­—æ®µæå–è¯æ®
  const evidence = this.extractAllEvidence(profileData);

  totalEvidence = evidence.length;

  if (totalEvidence === 0) {
    return 0;  // æ— è¯æ®
  }

  // è®¡ç®—å¼ºè¯æ®æ¯”ä¾‹
  strongEvidenceCount = evidence.filter(e =>
    e.strength === 'direct' || e.strength === 'strong'
  ).length;

  // è®¡ç®—å¹³å‡ç½®ä¿¡åº¦
  totalConfidence = evidence.reduce((sum, e) => sum + (e.confidence || 50), 0);
  const averageConfidence = totalConfidence / totalEvidence;

  // ç»¼åˆè¯„åˆ†
  const strongEvidenceRatio = strongEvidenceCount / totalEvidence;
  const evidenceDensity = Math.min(totalEvidence / 20, 1);  // 20æ¡è¯æ®ä¸ºæ»¡åˆ†

  const score = (
    strongEvidenceRatio * 40 +      // å¼ºè¯æ®æ¯”ä¾‹å 40%
    (averageConfidence / 100) * 40 + // å¹³å‡ç½®ä¿¡åº¦å 40%
    evidenceDensity * 20             // è¯æ®æ•°é‡å 20%
  );

  return Math.round(score);
}

/**
 * æå–æ‰€æœ‰è¯æ®ï¼ˆç”¨äºè´¨é‡è¯„ä¼°ï¼‰
 */
private extractAllEvidence(profileData: any): Evidence[] {
  const evidence: Evidence[] = [];

  // æŠ€èƒ½è¯æ®
  ['technicalSkills', 'softSkills'].forEach(skillType => {
    if (profileData[skillType]) {
      profileData[skillType].forEach((skill: any) => {
        if (skill.evidence) evidence.push(...skill.evidence);
      });
    }
  });

  // ç»éªŒè¯æ®
  if (profileData.experience?.evidence) {
    evidence.push(...profileData.experience.evidence);
  }

  // å…¶ä»–è¯æ®æº...
  if (profileData.evidenceSummary?.evidence) {
    evidence.push(...profileData.evidenceSummary.evidence);
  }

  return evidence;
}

/**
 * è¯†åˆ«ä¿¡æ¯ç¼ºå£
 */
private identifyGaps(profileData: ProfileData): string[] {
  const gaps: string[] = [];

  // æ£€æŸ¥æŠ€æœ¯æŠ€èƒ½
  if (!profileData.technicalSkills || profileData.technicalSkills.length < 3) {
    gaps.push('æŠ€æœ¯æŠ€èƒ½ä¿¡æ¯ä¸è¶³ï¼ˆå»ºè®®è‡³å°‘3é¡¹ï¼‰');
  }

  // æ£€æŸ¥è½¯æŠ€èƒ½
  if (!profileData.softSkills || profileData.softSkills.length < 2) {
    gaps.push('è½¯æŠ€èƒ½ä¿¡æ¯ä¸è¶³ï¼ˆå»ºè®®è‡³å°‘2é¡¹ï¼‰');
  }

  // æ£€æŸ¥å·¥ä½œç»éªŒ
  if (!profileData.experience || !profileData.experience.positions || profileData.experience.positions.length === 0) {
    gaps.push('ç¼ºå°‘å·¥ä½œç»å†è¯¦æƒ…');
  }

  // æ£€æŸ¥æ•™è‚²èƒŒæ™¯
  if (!profileData.education || !profileData.education.level) {
    gaps.push('ç¼ºå°‘æ•™è‚²èƒŒæ™¯ä¿¡æ¯');
  }

  // æ£€æŸ¥æ–‡åŒ–å¥‘åˆåº¦
  if (!profileData.culturalFit) {
    gaps.push('æœªè¯„ä¼°æ–‡åŒ–å¥‘åˆåº¦');
  }

  // æ£€æŸ¥èŒä¸šå‘å±•
  if (!profileData.careerTrajectory) {
    gaps.push('æœªåˆ†æèŒä¸šå‘å±•è½¨è¿¹');
  }

  // æ£€æŸ¥ç»„ç»‡å¥‘åˆåº¦
  if (!profileData.organizationalFit) {
    gaps.push('æœªè¿›è¡Œç»„ç»‡å¥‘åˆåº¦è¯„ä¼°');
  }

  return gaps;
}

/**
 * ç”Ÿæˆæ”¹è¿›å»ºè®®
 */
private generateRecommendations(
  profileData: ProfileData,
  gaps: string[],
  confidence: number
): string[] {
  const recommendations: string[] = [];

  // åŸºäºç½®ä¿¡åº¦çš„å»ºè®®
  if (confidence < 60) {
    recommendations.push('æ•´ä½“ä¿¡æ¯è´¨é‡è¾ƒä½ï¼Œå»ºè®®å®‰æ’æ·±åº¦é¢è¯•ä»¥è·å–æ›´å¤šè¯æ®');
  } else if (confidence < 80) {
    recommendations.push('ä¿¡æ¯è´¨é‡ä¸­ç­‰ï¼Œå»ºè®®é’ˆå¯¹ä¿¡æ¯ç¼ºå£è¿›è¡Œè¡¥å……é¢è¯•');
  }

  // åŸºäºä¿¡æ¯ç¼ºå£çš„å»ºè®®
  if (gaps.includes('æŠ€æœ¯æŠ€èƒ½ä¿¡æ¯ä¸è¶³ï¼ˆå»ºè®®è‡³å°‘3é¡¹ï¼‰')) {
    recommendations.push('å®‰æ’æŠ€æœ¯é¢è¯•ï¼Œæ·±å…¥è¯„ä¼°å€™é€‰äººçš„æŠ€æœ¯èƒ½åŠ›');
  }

  if (gaps.includes('è½¯æŠ€èƒ½ä¿¡æ¯ä¸è¶³ï¼ˆå»ºè®®è‡³å°‘2é¡¹ï¼‰')) {
    recommendations.push('é€šè¿‡è¡Œä¸ºé¢è¯•ï¼ˆSTARæ–¹æ³•ï¼‰æ”¶é›†æ›´å¤šè½¯æŠ€èƒ½è¯æ®');
  }

  if (gaps.includes('æœªè¯„ä¼°æ–‡åŒ–å¥‘åˆåº¦')) {
    recommendations.push('å®‰æ’æ–‡åŒ–å¥‘åˆåº¦é¢è¯•ï¼Œäº†è§£å€™é€‰äººçš„å·¥ä½œé£æ ¼å’Œä»·å€¼è§‚');
  }

  if (gaps.includes('æœªè¿›è¡Œç»„ç»‡å¥‘åˆåº¦è¯„ä¼°')) {
    recommendations.push('è¯„ä¼°å€™é€‰äººä¸å›¢é˜Ÿã€ç»„ç»‡çš„å¥‘åˆåº¦');
  }

  // åŸºäºè¯æ®å¼ºåº¦çš„å»ºè®®
  const evidence = this.extractAllEvidence(profileData);
  const weakEvidenceRatio = evidence.filter(e => e.strength === 'weak' || e.strength === 'inferential').length / evidence.length;

  if (weakEvidenceRatio > 0.5) {
    recommendations.push('å½“å‰è¯æ®è¾ƒå¤šåŸºäºæ¨æ–­ï¼Œå»ºè®®é€šè¿‡å®é™…æ¡ˆä¾‹æˆ–æµ‹è¯•è¿›è¡ŒéªŒè¯');
  }

  // å¦‚æœæ²¡æœ‰ç‰¹å®šå»ºè®®ï¼Œç»™å‡ºé€šç”¨å»ºè®®
  if (recommendations.length === 0) {
    recommendations.push('ç”»åƒè´¨é‡è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­é€šè¿‡é¢è¯•æ·±åŒ–ç†è§£');
  }

  return recommendations;
}

/**
 * ç¡®å®šè´¨é‡ç­‰çº§
 */
private determineQualityLevel(confidence: number): 'excellent' | 'good' | 'fair' | 'poor' {
  if (confidence >= 85) return 'excellent';
  if (confidence >= 70) return 'good';
  if (confidence >= 55) return 'fair';
  return 'poor';
}

/**
 * è®¡ç®—è¯¦ç»†è¯„åˆ†åˆ†è§£
 */
private calculateDetailedBreakdown(profileData: ProfileData): ProfileQualityMetrics['breakdown'] {
  return {
    technicalSkillsCoverage: this.scoreSkillsCoverage(profileData.technicalSkills, 'technical'),
    softSkillsCoverage: this.scoreSkillsCoverage(profileData.softSkills, 'soft'),
    experienceVerification: this.scoreExperienceVerification(profileData.experience),
    culturalFitAssessment: this.scoreCulturalFit(profileData.culturalFit),
    evidenceQuality: this.calculateEvidenceStrength(profileData)
  };
}

private scoreSkillsCoverage(skills: any[] | undefined, type: 'technical' | 'soft'): number {
  if (!skills || skills.length === 0) return 0;

  const targetCount = type === 'technical' ? 5 : 3;
  const coverageScore = Math.min(skills.length / targetCount, 1) * 60;

  const evidenceScore = skills.filter(s => s.evidence && s.evidence.length > 0).length / skills.length * 40;

  return Math.round(coverageScore + evidenceScore);
}

private scoreExperienceVerification(experience: any): number {
  if (!experience) return 0;

  let score = 0;

  if (experience.totalYears > 0) score += 30;
  if (experience.positions && experience.positions.length > 0) score += 40;
  if (experience.positions?.some((p: any) => p.keyAchievements?.length > 0)) score += 30;

  return score;
}

private scoreCulturalFit(culturalFit: any): number {
  if (!culturalFit) return 0;

  let score = 0;

  if (culturalFit.workStyle) score += 40;
  if (culturalFit.motivations && culturalFit.motivations.length > 0) score += 30;
  if (culturalFit.preferences && culturalFit.preferences.length > 0) score += 30;

  return score;
}
```

**åœ¨ç”»åƒç”Ÿæˆæ—¶è‡ªåŠ¨è¯„ä¼°è´¨é‡**:

```typescript
// server/services/candidateProfileService.ts

async buildInitialProfile(
  candidateId: string,
  resumeAnalysis: ResumeAnalysis,
  jobId?: string
): Promise<CandidateProfile> {
  // ... ç°æœ‰é€»è¾‘

  const profile = await storage.createCandidateProfile({
    // ... ç°æœ‰å­—æ®µ
  });

  // âœ¨ æ–°å¢ï¼šè¯„ä¼°ç”»åƒè´¨é‡
  const qualityMetrics = await this.assessProfileQuality(profile);

  this.log('info', 'åˆå§‹ç”»åƒè´¨é‡è¯„ä¼°', {
    profileId: profile.id,
    qualityLevel: qualityMetrics.qualityLevel,
    confidence: qualityMetrics.confidence,
    gaps: qualityMetrics.gaps,
    recommendations: qualityMetrics.recommendations
  });

  // å¯é€‰ï¼šå°†è´¨é‡è¯„ä¼°ç»“æœå­˜å‚¨åˆ°ç”»åƒä¸­
  // æˆ–è¿”å›ç»™å‰ç«¯å±•ç¤º

  return profile;
}
```

**å‰ç«¯å±•ç¤ºè´¨é‡æŒ‡æ ‡**:

```typescript
// client/src/components/profile-quality-indicator.tsx
interface ProfileQualityIndicatorProps {
  qualityMetrics: ProfileQualityMetrics;
}

export function ProfileQualityIndicator({ qualityMetrics }: ProfileQualityIndicatorProps) {
  const { qualityLevel, confidence, gaps, recommendations, breakdown } = qualityMetrics;

  const qualityConfig = {
    excellent: { color: 'green', label: 'ä¼˜ç§€', icon: CheckCircle2 },
    good: { color: 'blue', label: 'è‰¯å¥½', icon: ThumbsUp },
    fair: { color: 'yellow', label: 'ä¸€èˆ¬', icon: AlertCircle },
    poor: { color: 'red', label: 'è¾ƒå·®', icon: XCircle }
  };

  const config = qualityConfig[qualityLevel];

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <config.icon className={`h-5 w-5 text-${config.color}-600`} />
          ç”»åƒè´¨é‡è¯„ä¼°
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* æ•´ä½“è¯„åˆ† */}
        <div className="flex items-center justify-between">
          <span className="text-sm font-medium">æ•´ä½“ç½®ä¿¡åº¦</span>
          <div className="flex items-center gap-2">
            <Progress value={confidence} className="w-32" />
            <span className="text-lg font-bold">{confidence}%</span>
          </div>
        </div>

        {/* è¯¦ç»†è¯„åˆ† */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium">è¯¦ç»†è¯„åˆ†</h4>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <div>æŠ€æœ¯æŠ€èƒ½: {breakdown.technicalSkillsCoverage}%</div>
            <div>è½¯æŠ€èƒ½: {breakdown.softSkillsCoverage}%</div>
            <div>ç»éªŒéªŒè¯: {breakdown.experienceVerification}%</div>
            <div>æ–‡åŒ–å¥‘åˆ: {breakdown.culturalFitAssessment}%</div>
            <div className="col-span-2">è¯æ®è´¨é‡: {breakdown.evidenceQuality}%</div>
          </div>
        </div>

        {/* ä¿¡æ¯ç¼ºå£ */}
        {gaps.length > 0 && (
          <div className="space-y-2">
            <h4 className="text-sm font-medium text-amber-700">ä¿¡æ¯ç¼ºå£</h4>
            <ul className="text-sm text-muted-foreground space-y-1">
              {gaps.map((gap, i) => (
                <li key={i} className="flex items-start gap-2">
                  <AlertCircle className="h-4 w-4 shrink-0 mt-0.5" />
                  {gap}
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* æ”¹è¿›å»ºè®® */}
        {recommendations.length > 0 && (
          <div className="space-y-2">
            <h4 className="text-sm font-medium text-blue-700">æ”¹è¿›å»ºè®®</h4>
            <ul className="text-sm text-muted-foreground space-y-1">
              {recommendations.map((rec, i) => (
                <li key={i} className="flex items-start gap-2">
                  <Lightbulb className="h-4 w-4 shrink-0 mt-0.5" />
                  {rec}
                </li>
              ))}
            </ul>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

#### å®æ–½æ­¥éª¤

1. **æ·»åŠ è´¨é‡è¯„ä¼°æ–¹æ³•**ï¼ˆ2-3å°æ—¶ï¼‰
2. **é›†æˆåˆ°ç”»åƒç”Ÿæˆæµç¨‹**ï¼ˆ1å°æ—¶ï¼‰
3. **åˆ›å»ºå‰ç«¯è´¨é‡æŒ‡æ ‡ç»„ä»¶**ï¼ˆ2-3å°æ—¶ï¼‰
4. **ç¼–å†™æµ‹è¯•**ï¼ˆ2å°æ—¶ï¼‰
5. **åœ¨å€™é€‰äººè¯¦æƒ…é¡µå±•ç¤º**ï¼ˆ1å°æ—¶ï¼‰

#### é¢„æœŸæ”¶ç›Š

- âœ… ç”¨æˆ·äº†è§£ç”»åƒè´¨é‡
- âœ… æä¾›å¯æ“ä½œçš„æ”¹è¿›å»ºè®®
- âœ… é‡åŒ–ä¿¡æ¯å®Œæ•´åº¦
- âœ… æŒ‡å¯¼ä¸‹ä¸€æ­¥é¢è¯•é‡ç‚¹

---

### ğŸŸ¢ è½»å¾®é—®é¢˜ 5: å‰ç«¯æ€§èƒ½ä¼˜åŒ–ç©ºé—´

#### é—®é¢˜æè¿°

**å½±å“èŒƒå›´**: `client/src/components/profile-evolution-timeline.tsx`

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ **ä½** - ä»…åœ¨æç«¯åœºæ™¯ä¸‹å½±å“æ€§èƒ½

**å½“å‰å®ç°**:
- âœ… ä½¿ç”¨ `useMemo` ä¼˜åŒ–è®¡ç®—
- âœ… å“åº”å¼è®¾è®¡
- âœ… æ— éšœç¢æ”¯æŒ
- âš ï¸ æœªä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆ20+ ç‰ˆæœ¬æ—¶å¯èƒ½å¡é¡¿ï¼‰

#### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **æ€§èƒ½** | ğŸŸ¢ ä½ | ä»…åœ¨20+ç‰ˆæœ¬æ—¶å½±å“ |
| **ç”¨æˆ·ä½“éªŒ** | ğŸŸ¢ ä½ | å¤§å¤šæ•°åœºæ™¯æµç•… |
| **å‘ç”Ÿæ¦‚ç‡** | ğŸŸ¢ ä½ | å¾ˆå°‘æœ‰å€™é€‰äººç»å†20+è½®é¢è¯• |
| **ä¿®å¤éš¾åº¦** | ğŸŸ¢ ä½ | ä½¿ç”¨ react-window å³å¯ |

#### ä¿®å¤æ–¹æ¡ˆ

**å¯é€‰ä¼˜åŒ–ï¼šè™šæ‹Ÿæ»šåŠ¨**ï¼ˆä»…åœ¨éœ€è¦æ—¶å®æ–½ï¼‰

```bash
npm install react-window
```

```typescript
// client/src/components/profile-evolution-timeline.tsx
import { FixedSizeList as List } from 'react-window';

export const ProfileEvolutionTimeline = ({ profiles, onSelectProfile }) => {
  // å¦‚æœç‰ˆæœ¬æ•°é‡è¶…è¿‡20ï¼Œå¯ç”¨è™šæ‹Ÿæ»šåŠ¨
  const USE_VIRTUAL_SCROLL = profiles.length > 20;

  if (USE_VIRTUAL_SCROLL) {
    const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => {
      const profile = timelineData.items[index].profile;

      return (
        <div style={style}>
          <TimelineNode
            profile={profile}
            // ... å…¶ä»– props
          />
        </div>
      );
    };

    return (
      <List
        height={800}
        itemCount={profiles.length}
        itemSize={250}
        width="100%"
      >
        {Row}
      </List>
    );
  }

  // æ­£å¸¸æ¸²æŸ“ï¼ˆ< 20 ä¸ªç‰ˆæœ¬ï¼‰
  return (
    <div>
      {timelineData.items.map(({ profile }) => (
        <TimelineNode key={profile.id} profile={profile} />
      ))}
    </div>
  );
};
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬ 1 å‘¨: ä¸¥é‡é—®é¢˜ä¿®å¤

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº |
|------|--------|---------|--------|
| **ä¿®å¤ç‰ˆæœ¬å·å¹¶å‘é—®é¢˜** | ğŸ”´ P0 | 4 å°æ—¶ | åç«¯å¼€å‘ |
| - å®ç°äº‹åŠ¡ + è¡Œé” | | 2 å°æ—¶ | |
| - ç¼–å†™å•å…ƒæµ‹è¯• | | 1 å°æ—¶ | |
| - å¹¶å‘å‹æµ‹éªŒè¯ | | 1 å°æ—¶ | QA |
| **å®Œå–„è¯æ®æå–é€»è¾‘** | ğŸŸ¡ P1 | 5 å°æ—¶ | åç«¯å¼€å‘ |
| - æ·»åŠ æ‰€æœ‰è¯æ®æå–æ–¹æ³• | | 3 å°æ—¶ | |
| - å®ç°å»é‡é€»è¾‘ | | 1 å°æ—¶ | |
| - ç¼–å†™æµ‹è¯• | | 1 å°æ—¶ | |

### ç¬¬ 2-3 å‘¨: ä¸­ç­‰é—®é¢˜æ”¹è¿›

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº |
|------|--------|---------|--------|
| **ä¼˜åŒ– AI æç¤ºè¯ç®¡ç†** | ğŸŸ¡ P1 | 6 å°æ—¶ | åç«¯å¼€å‘ |
| - Token ä¼°ç®—å’Œå‹ç¼© | | 3 å°æ—¶ | |
| - æ™ºèƒ½æ‘˜è¦é€»è¾‘ | | 2 å°æ—¶ | |
| - æµ‹è¯•å’Œè°ƒä¼˜ | | 1 å°æ—¶ | |
| **æ·»åŠ ç”»åƒè´¨é‡è¯„åˆ†** | ğŸŸ¢ P2 | 8 å°æ—¶ | å…¨æ ˆå¼€å‘ |
| - åç«¯è¯„åˆ†ç®—æ³• | | 4 å°æ—¶ | |
| - å‰ç«¯è´¨é‡æŒ‡æ ‡ç»„ä»¶ | | 3 å°æ—¶ | |
| - é›†æˆå’Œæµ‹è¯• | | 1 å°æ—¶ | |

### ç¬¬ 4 å‘¨: æµ‹è¯•å’Œå‘å¸ƒ

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ | è´Ÿè´£äºº |
|------|--------|---------|--------|
| **é›†æˆæµ‹è¯•** | ğŸ”´ P0 | 4 å°æ—¶ | QA |
| **æ€§èƒ½æµ‹è¯•** | ğŸŸ¡ P1 | 2 å°æ—¶ | QA |
| **æ–‡æ¡£æ›´æ–°** | ğŸŸ¡ P1 | 2 å°æ—¶ | æŠ€æœ¯å†™ä½œ |
| **ç”Ÿäº§éƒ¨ç½²** | ğŸ”´ P0 | 2 å°æ—¶ | DevOps |

**æ€»å·¥æ—¶ä¼°ç®—**: çº¦ **33 å°æ—¶**ï¼ˆ4 ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

- [ ] `createCandidateProfile` å¹¶å‘å®‰å…¨æµ‹è¯•
- [ ] `extractEvidenceFromProfile` å®Œæ•´æ€§æµ‹è¯•
- [ ] Token ä¼°ç®—å‡†ç¡®æ€§æµ‹è¯•
- [ ] ç”»åƒè´¨é‡è¯„åˆ†ç®—æ³•æµ‹è¯•

### é›†æˆæµ‹è¯•

- [ ] å®Œæ•´çš„ç”»åƒç”Ÿæˆæµç¨‹æµ‹è¯•
- [ ] å¤šè½®é¢è¯•æ›´æ–°æµç¨‹æµ‹è¯•
- [ ] è¯æ®é“¾æ•´åˆæµ‹è¯•

### æ€§èƒ½æµ‹è¯•

- [ ] å¹¶å‘åˆ›å»ºç”»åƒå‹æµ‹ï¼ˆ100 å¹¶å‘ï¼‰
- [ ] å¤§é‡è¯æ®åœºæ™¯æµ‹è¯•ï¼ˆ500+ æ¡è¯æ®ï¼‰
- [ ] å¤šç‰ˆæœ¬æ¸²æŸ“æ€§èƒ½æµ‹è¯•ï¼ˆ30+ ç‰ˆæœ¬ï¼‰

### å›å½’æµ‹è¯•

- [ ] ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“
- [ ] éªŒè¯å‰ç«¯å±•ç¤ºæ­£å¸¸
- [ ] éªŒè¯ API å“åº”æ ¼å¼ä¸å˜

---

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡

- [ ] ç‰ˆæœ¬å·å†²çªç‡ = 0%
- [ ] è¯æ®æå–å®Œæ•´åº¦ > 95%
- [ ] AI Token ä½¿ç”¨æ•ˆç‡æå‡ 30%+
- [ ] ç”»åƒè´¨é‡è¯„åˆ†è¦†ç›–ç‡ = 100%

### ä¸šåŠ¡æŒ‡æ ‡

- [ ] ç”»åƒç”ŸæˆæˆåŠŸç‡ > 99%
- [ ] ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ† > 4.5/5
- [ ] ç”»åƒæ›´æ–°å“åº”æ—¶é—´ < 10s

---

## ğŸ”§ å›æ»šè®¡åˆ’

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **ç«‹å³å›æ»šä»£ç **
   ```bash
   git revert <commit-hash>
   git push origin main
   ```

2. **æ•°æ®åº“å›æ»š**ï¼ˆå¦‚æœæœ‰ schema å˜æ›´ï¼‰
   ```bash
   psql -h your-host -U postgres -d your-db < backup_YYYYMMDD_HHMMSS.sql
   ```

3. **é€šçŸ¥å›¢é˜Ÿå’Œç”¨æˆ·**

4. **åˆ†æå¤±è´¥åŸå› ï¼Œé‡æ–°è®¡åˆ’ä¿®å¤**

---

## ğŸ“š é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

**åç«¯æ–‡ä»¶**:
- `shared/schema.ts:200-244` - ç”»åƒè¡¨å®šä¹‰
- `server/storage.ts:1074-1126` - ç”»åƒåˆ›å»ºé€»è¾‘
- `server/services/candidateProfileService.ts` - ç”»åƒæœåŠ¡ï¼ˆ1553 è¡Œï¼‰
- `server/routes.ts:1787-1821, 2213-2269` - API è·¯ç”±

**å‰ç«¯æ–‡ä»¶**:
- `client/src/components/profile-evolution-timeline.tsx` - æ—¶é—´çº¿ç»„ä»¶
- `client/src/components/profile-card-enhanced.tsx` - ç”»åƒå¡ç‰‡
- `client/src/pages/candidate-detail.tsx` - å€™é€‰äººè¯¦æƒ…é¡µ

### B. æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE candidate_profiles (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  candidate_id VARCHAR NOT NULL REFERENCES candidates(id) ON DELETE CASCADE,
  job_id VARCHAR REFERENCES jobs(id) ON DELETE SET NULL,
  version INTEGER NOT NULL,  -- ç‰ˆæœ¬å·ï¼ˆè‡ªåŠ¨é€’å¢ï¼‰
  stage TEXT NOT NULL,       -- é˜¶æ®µæ ‡è®°
  profile_data JSONB NOT NULL,
  overall_score DECIMAL(5, 2),
  data_sources JSONB,
  gaps JSONB,
  strengths JSONB,
  concerns JSONB,
  ai_summary TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(candidate_id, version)  -- ç‰ˆæœ¬å”¯ä¸€æ€§çº¦æŸ
);
```

### C. å…³é”®æŒ‡æ ‡ç›‘æ§

```typescript
// å»ºè®®æ·»åŠ çš„ç›‘æ§æŒ‡æ ‡
const MONITORING_METRICS = {
  // ç”»åƒç”Ÿæˆ
  'profile.creation.success_rate': 'ç”»åƒåˆ›å»ºæˆåŠŸç‡',
  'profile.creation.duration_ms': 'ç”»åƒåˆ›å»ºè€—æ—¶',
  'profile.version_conflicts': 'ç‰ˆæœ¬å·å†²çªæ¬¡æ•°',

  // AI è°ƒç”¨
  'ai.token_usage': 'AI Token ä½¿ç”¨é‡',
  'ai.call_duration_ms': 'AI è°ƒç”¨è€—æ—¶',
  'ai.error_rate': 'AI è°ƒç”¨å¤±è´¥ç‡',

  // è¯æ®ç³»ç»Ÿ
  'evidence.extraction_count': 'è¯æ®æå–æ•°é‡',
  'evidence.contradiction_count': 'è¯æ®çŸ›ç›¾æ•°é‡',
  'evidence.quality_score': 'è¯æ®è´¨é‡åˆ†æ•°',

  // ç”»åƒè´¨é‡
  'profile.quality.average_score': 'å¹³å‡è´¨é‡åˆ†æ•°',
  'profile.quality.gaps_count': 'å¹³å‡ä¿¡æ¯ç¼ºå£æ•°é‡',
};
```

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®¡æŸ¥æŠ¥å‘Š**: è¯·ä»”ç»†å®¡æŸ¥æœ¬æŠ¥å‘Šï¼Œç¡®è®¤ä¿®å¤æ–¹æ¡ˆ
2. **ç¡®è®¤ä¼˜å…ˆçº§**: ç¡®è®¤æ˜¯å¦åŒæ„å»ºè®®çš„ä¼˜å…ˆçº§æ’åº
3. **èµ„æºåˆ†é…**: åˆ†é…å¼€å‘èµ„æºå’Œæ—¶é—´è¡¨
4. **å¼€å§‹ä¿®å¤**: ä» P0 ä¸¥é‡é—®é¢˜å¼€å§‹é€æ­¥ä¿®å¤
5. **æŒç»­è·Ÿè¸ª**: ä½¿ç”¨é¡¹ç›®ç®¡ç†å·¥å…·è·Ÿè¸ªè¿›åº¦

---

**æŠ¥å‘Šç”Ÿæˆè€…**: Claude (AI Assistant)
**å®¡æŸ¥çŠ¶æ€**: å¾…å®¡æŸ¥
**æœ€åæ›´æ–°**: 2025-10-09
